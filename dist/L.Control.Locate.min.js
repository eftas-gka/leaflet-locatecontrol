/*
Copyright (c) 2014, 2015 Dominik Moritz, Georg Kaspar

This file is part of the leaflet locate control. It is licensed under the MIT license.
You can find the project at: https://github.com/domoritz/leaflet-locatecontrol
*/
(function(a,b){if(typeof define==="function"&&define.amd){define(["leaflet"],a)}else{if(typeof exports==="object"){if(typeof b!=="undefined"&&b.L){module.exports=a(L)}else{module.exports=a(require("leaflet"))}}}if(typeof b!=="undefined"&&b.L){b.L.Locate=a(L)}}(function(a){a.Control.Locate=a.Control.extend({options:{position:"topleft",drawCircle:true,follow:false,stopFollowingOnDrag:false,remainActive:false,markerClass:a.circleMarker,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:0.15,weight:2,opacity:0.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:0.7,weight:2,opacity:0.9,radius:5},followCircleStyle:{},followMarkerStyle:{},icon:"fa fa-map-marker",iconFollowing:"fa fa-map-marker",iconLoading:"fa fa-spinner fa-spin",circlePadding:[0,0],metric:true,onLocationError:function(b){alert(b.message)},onLocationOutsideMapBounds:function(b){b.stop();alert(b.options.strings.outsideMapBoundsMsg)},setView:true,keepCurrentZoomLevel:false,showPopup:true,strings:{title:"Show me where I am",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:Infinity,watch:true}},initialize:function(b){a.Map.addInitHook(function(){if(this.options.locateControl){this.locateControl=a.control.locate();this.addControl(this.locateControl)}});for(var c in b){if(typeof this.options[c]==="object"){a.extend(this.options[c],b[c])}else{this.options[c]=b[c]}}a.extend(this.options.locateOptions,{setView:false})},_activate:function(){if(this.options.setView){this._locateOnNextLocationFound=true}if(!this._active){this._map.locate(this.options.locateOptions)}this._active=true;if(this.options.follow){this._startFollowing(this._map)}},_deactivate:function(){this._map.stopLocate();this._map.off("dragstart",this._stopFollowing);if(this.options.follow&&this._following){this._stopFollowing(this._map)}},drawMarker:function(g){if(this._event.accuracy===undefined){this._event.accuracy=0}var b=this._event.accuracy;if(this._locateOnNextLocationFound){if(this._isOutsideMapBounds()){this.options.onLocationOutsideMapBounds(this)}else{if(this.options.keepCurrentZoomLevel&&!this.options.drawCircle){g.panTo([this._event.latitude,this._event.longitude])}else{g.fitBounds(this._event.bounds,{padding:this.options.circlePadding,maxZoom:this.options.keepCurrentZoomLevel?g.getZoom():this.options.locateOptions.maxZoom})}}this._locateOnNextLocationFound=false}var e,h;if(this.options.drawCircle){if(this._following){e=this.options.followCircleStyle}else{e=this.options.circleStyle}if(!this._circle){this._circle=a.circle(this._event.latlng,b,e).addTo(this._layer)}else{this._circle.setLatLng(this._event.latlng).setRadius(b);for(h in e){this._circle.options[h]=e[h]}}}var i,f;if(this.options.metric){i=b.toFixed(0);f="meters"}else{i=(b*3.2808399).toFixed(0);f="feet"}var c;if(this._following){c=this.options.followMarkerStyle}else{c=this.options.markerStyle}if(!this._marker){this._marker=this.createMarker(this._event.latlng,c).addTo(this._layer)}else{this.updateMarker(this._event.latlng,c)}var d=this.options.strings.popup;if(this.options.showPopup&&d){this._marker.bindPopup(a.Util.template(d,{distance:i,unit:f}))._popup.setLatLng(this._event.latlng)}this._toggleContainerStyle()},createMarker:function(c,b){return this.options.markerClass(c,b)},updateMarker:function(d,b){this._marker.setLatLng(d);for(var c in b){this._marker.options[c]=b[c]}},removeMarker:function(){this._layer.clearLayers();this._marker=undefined;this._circle=undefined},onAdd:function(d){var b=a.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control");this._layer=new a.LayerGroup();this._layer.addTo(d);this._event=undefined;var c={};a.extend(c,this.options.markerStyle,this.options.followMarkerStyle);this.options.followMarkerStyle=c;c={};a.extend(c,this.options.circleStyle,this.options.followCircleStyle);this.options.followCircleStyle=c;this._link=a.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",b);this._link.href="#";this._link.title=this.options.strings.title;this._icon=a.DomUtil.create("span",this.options.icon,this._link);a.DomEvent.on(this._link,"click",a.DomEvent.stopPropagation).on(this._link,"click",a.DomEvent.preventDefault).on(this._link,"click",function(){var e=(this._event===undefined||this._map.getBounds().contains(this._event.latlng)||!this.options.setView||this._isOutsideMapBounds());if(!this.options.remainActive&&(this._active&&e)){this.stop()}else{this.start()}},this).on(this._link,"dblclick",a.DomEvent.stopPropagation);this._resetVariables();this.bindEvents(d);return b},bindEvents:function(b){b.on("locationfound",this._onLocationFound,this);b.on("locationerror",this._onLocationError,this);b.on("unload",this.stop,this)},start:function(){this._activate();if(!this._event){this._setClasses("requesting")}else{this.drawMarker(this._map)}},stop:function(){this._deactivate();this._cleanClasses();this._resetVariables();this.removeMarker()},_onLocationError:function(b){if(b.code==3&&this.options.locateOptions.watch){return}this.stop();this.options.onLocationError(b)},_onLocationFound:function(b){if(this._event&&(this._event.latlng.lat===b.latlng.lat&&this._event.latlng.lng===b.latlng.lng&&this._event.accuracy===b.accuracy)){return}if(!this._active){return}this._event=b;if(this.options.follow&&this._following){this._locateOnNextLocationFound=true}this.drawMarker(this._map)},_startFollowing:function(){this._map.fire("startfollowing",this);this._following=true;if(this.options.stopFollowingOnDrag){this._map.on("dragstart",this._stopFollowing,this)}},_stopFollowing:function(){this._map.fire("stopfollowing",this);this._following=false;if(this.options.stopFollowingOnDrag){this._map.off("dragstart",this._stopFollowing)}this._toggleContainerStyle()},_isOutsideMapBounds:function(){if(this._event===undefined){return false}return this._map.options.maxBounds&&!this._map.options.maxBounds.contains(this._event.latlng)},_toggleContainerStyle:function(){if(!this._container){return}if(this._following){this._setClasses("following")}else{this._setClasses("active")}},_setClasses:function(b){if(b=="requesting"){a.DomUtil.removeClasses(this._container,"active following");a.DomUtil.addClasses(this._container,"requesting");a.DomUtil.removeClasses(this._icon,this.options.icon);a.DomUtil.removeClasses(this._icon,this.options.iconFollowing);a.DomUtil.addClasses(this._icon,this.options.iconLoading)}else{if(b=="active"){a.DomUtil.removeClasses(this._container,"requesting following");a.DomUtil.addClasses(this._container,"active");a.DomUtil.removeClasses(this._icon,this.options.iconFollowing);a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)}else{if(b=="following"){a.DomUtil.removeClasses(this._container,"requesting");a.DomUtil.addClasses(this._container,"active following");a.DomUtil.removeClasses(this._icon,this.options.icon);a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.iconFollowing)}}}},_cleanClasses:function(){a.DomUtil.removeClass(this._container,"requesting");a.DomUtil.removeClass(this._container,"active");a.DomUtil.removeClass(this._container,"following");a.DomUtil.removeClasses(this._icon,this.options.iconFollowing);a.DomUtil.removeClasses(this._icon,this.options.iconLoading);a.DomUtil.addClasses(this._icon,this.options.icon)},_resetVariables:function(){this._active=false;this._locateOnNextLocationFound=this.options.setView;this._following=false}});a.Map.addInitHook(function(){if(this.options.locateControl){this.locateControl=a.control.locate();this.addControl(this.locateControl)}});a.control.locate=function(b){return new a.Control.Locate(b)};(function(){var b=function(e,c,d){d=d.split(" ");d.forEach(function(f){a.DomUtil[e].call(this,c,f)})};a.DomUtil.addClasses=function(c,d){b("addClass",c,d)};a.DomUtil.removeClasses=function(c,d){b("removeClass",c,d)}})();return a.Control.Locate},window));